{% extends "layout.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/card_panel.html" as panels %}
{% import "components/forms.html" as forms %}

{% block content %}
<div x-data="alsaSettingsApp()" x-init="init()">
  <header class="page-header">
    <h1 class="page-title">{{ t('alsa_page_title') }}</h1>
    <p class="page-subtitle">{{ t('alsa_page_subtitle') }}</p>
  </header>

  <div class="grid grid-2">
    {% call panels.card_panel(t('section_device_selection')) %}
      {{ forms.select_input('alsaInput', t('label_input_device'), 'config.alsa.input_device', 'devices.capture') }}
      {{ forms.select_input('alsaOutput', t('label_output_device'), 'config.alsa.output_device', 'devices.playback') }}
      <div class="notice" x-show="!devices.capture.length || !devices.playback.length">
        {{ t('notice_devices_empty') }}
      </div>
    {% endcall %}

    {% call panels.card_panel(t('section_stream_parameters')) %}
      {{ forms.text_input('alsaRate', t('label_sample_rate'), 'config.alsa.sample_rate', type='number', placeholder=t('placeholder_auto')) }}
      {{ forms.text_input('alsaChannels', t('label_channels'), 'config.alsa.channels', type='number', placeholder=t('placeholder_channels_default')) }}
      {{ forms.select_input('alsaFormat', t('label_format'), 'config.alsa.format', 'formatOptions') }}
      {{ forms.text_input('alsaPeriod', t('label_period_frames'), 'config.alsa.period_frames', type='number', placeholder=t('placeholder_auto')) }}
      {{ forms.text_input('alsaBuffer', t('label_buffer_frames'), 'config.alsa.buffer_frames', type='number', placeholder=t('placeholder_auto')) }}
    {% endcall %}

    {% call panels.card_panel(t('section_filter_settings')) %}
      {{ forms.select_input('filterRatio', t('label_upsample_ratio'), 'config.filter.ratio', 'ratioOptions') }}
      {{ forms.select_input('filterPhase', t('label_phase_type'), 'config.filter.phase_type', 'phaseOptions') }}
      {{ forms.text_input('filterDir', t('label_filter_directory'), 'config.filter.directory', placeholder=t('placeholder_filter_directory')) }}
    {% endcall %}
  </div>

  {% call panels.card_panel(t('section_apply_settings')) %}
    <div class="profile-actions">
      {{ buttons.btn_primary(t('btn_save_apply'), click='saveConfig()', disabled='actionPending') }}
      {{ buttons.btn_primary(t('btn_reload_devices'), click='fetchDevices()', disabled='actionPending', extra_class='btn-secondary') }}
      {{ buttons.btn_primary(t('btn_refresh_config'), click='fetchConfig()', disabled='actionPending', extra_class='btn-secondary') }}
    </div>
    <div class="notice success" x-show="actionMessage" x-text="actionMessage" style="margin-top: 16px;"></div>
    <div class="notice error" x-show="actionError" x-text="actionError" style="margin-top: 16px;"></div>
  {% endcall %}
</div>

<script>
function alsaSettingsApp() {
  return {
    devices: { playback: [], capture: [] },
    formatOptions: ['S16_LE', 'S24_3LE', 'S32_LE'],
    config: {
      alsa: {
        input_device: '',
        output_device: '',
        sample_rate: '',
        channels: '',
        format: 'S32_LE',
        period_frames: '',
        buffer_frames: ''
      },
      filter: {
        ratio: 2,
        phase_type: 'minimum',
        directory: ''
      }
    },
    ratioOptions: [
      { label: t('ratio_1x_bypass'), value: 1 },
      { label: t('ratio_2x'), value: 2 },
      { label: t('ratio_4x'), value: 4 },
      { label: t('ratio_8x'), value: 8 },
      { label: t('ratio_16x'), value: 16 }
    ],
    phaseOptions: [
      { label: t('phase_minimum'), value: 'minimum' },
      { label: t('phase_linear'), value: 'linear' }
    ],
    actionPending: false,
    actionMessage: null,
    actionError: null,
    init() {
      this.fetchDevices();
      this.fetchConfig();
    },
    async fetchDevices() {
      try {
        const response = await fetch('/api/alsa/devices');
        if (!response.ok) {
          throw new Error(t('error_failed_load_devices'));
        }
        const data = await response.json();
        this.devices.playback = data.playback || [];
        this.devices.capture = data.capture || [];
      } catch (err) {
        this.actionError = err.message;
      }
    },
    async fetchConfig() {
      try {
        const response = await fetch('/api/config');
        if (!response.ok) {
          throw new Error(t('error_failed_load_config'));
        }
        const data = await response.json();
        const settings = data.settings || {};
        const alsa = settings.alsa || {};
        const filter = settings.filter || {};
        this.config.alsa.input_device = alsa.input_device || '';
        this.config.alsa.output_device = alsa.output_device || '';
        this.config.alsa.sample_rate = alsa.sample_rate || '';
        this.config.alsa.channels = alsa.channels || '';
        this.config.alsa.format = alsa.format || this.config.alsa.format;
        this.config.alsa.period_frames = alsa.period_frames || '';
        this.config.alsa.buffer_frames = alsa.buffer_frames || '';
        this.config.filter.ratio = filter.ratio || this.config.filter.ratio;
        this.config.filter.phase_type = filter.phase_type || this.config.filter.phase_type;
        this.config.filter.directory = filter.directory || '';
      } catch (err) {
        this.actionError = err.message;
      }
    },
    async saveConfig() {
      this.actionPending = true;
      this.actionMessage = null;
      this.actionError = null;
      const payload = {
        alsa: {
          input_device: this.config.alsa.input_device || null,
          output_device: this.config.alsa.output_device || null,
          sample_rate: this.config.alsa.sample_rate ? Number(this.config.alsa.sample_rate) : null,
          channels: this.config.alsa.channels ? Number(this.config.alsa.channels) : null,
          format: this.config.alsa.format || null,
          period_frames: this.config.alsa.period_frames ? Number(this.config.alsa.period_frames) : null,
          buffer_frames: this.config.alsa.buffer_frames ? Number(this.config.alsa.buffer_frames) : null
        },
        filter: {
          ratio: this.config.filter.ratio ? Number(this.config.filter.ratio) : null,
          phase_type: this.config.filter.phase_type || null,
          directory: this.config.filter.directory || null
        }
      };
      try {
        const response = await fetch('/api/config', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || t('error_failed_save_config'));
        }
        const data = await response.json();
        if (data.restart_required) {
          this.actionMessage = t('message_saved_restart_required');
        } else {
          this.actionMessage = t('message_saved_applied');
        }
      } catch (err) {
        this.actionError = err.message;
      } finally {
        this.actionPending = false;
      }
    }
  };
}
</script>
{% endblock %}

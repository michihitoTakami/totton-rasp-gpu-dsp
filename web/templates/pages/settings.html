{% extends "layout.html" %}
{% import "components/buttons.html" as buttons %}
{% import "components/card_panel.html" as panels %}
{% import "components/forms.html" as forms %}

{% block content %}
<div x-data="alsaSettingsApp()" x-init="init()">
  <header class="page-header">
    <h1 class="page-title">ALSA Device Settings</h1>
    <p class="page-subtitle">Select capture/playback devices and persist settings.</p>
  </header>

  <div class="grid grid-2">
    {% call panels.card_panel("Device Selection") %}
      {{ forms.select_input('alsaInput', 'Input Device', 'config.alsa.input_device', 'devices.capture') }}
      {{ forms.select_input('alsaOutput', 'Output Device', 'config.alsa.output_device', 'devices.playback') }}
      <div class="notice" x-show="!devices.capture.length || !devices.playback.length">
        Device list is empty or unavailable. Ensure the DSP daemon is running.
      </div>
    {% endcall %}

    {% call panels.card_panel("Stream Parameters") %}
      {{ forms.text_input('alsaRate', 'Sample Rate (Hz)', 'config.alsa.sample_rate', type='number', placeholder='Auto') }}
      {{ forms.text_input('alsaChannels', 'Channels', 'config.alsa.channels', type='number', placeholder='2') }}
      {{ forms.select_input('alsaFormat', 'Format', 'config.alsa.format', 'formatOptions') }}
      {{ forms.text_input('alsaPeriod', 'Period Frames', 'config.alsa.period_frames', type='number', placeholder='Auto') }}
      {{ forms.text_input('alsaBuffer', 'Buffer Frames', 'config.alsa.buffer_frames', type='number', placeholder='Auto') }}
    {% endcall %}

    {% call panels.card_panel("Filter Settings") %}
      {{ forms.select_input('filterRatio', 'Upsample Ratio', 'config.filter.ratio', 'ratioOptions') }}
      {{ forms.select_input('filterPhase', 'Phase Type', 'config.filter.phase_type', 'phaseOptions') }}
      {{ forms.text_input('filterDir', 'Filter Directory', 'config.filter.directory', placeholder='/opt/totton-dsp/data/coefficients') }}
    {% endcall %}
  </div>

  {% call panels.card_panel("Apply Settings") %}
    <div class="profile-actions">
      {{ buttons.btn_primary('Save & Apply', click='saveConfig()', disabled='actionPending') }}
      {{ buttons.btn_primary('Reload Devices', click='fetchDevices()', disabled='actionPending', extra_class='btn-secondary') }}
      {{ buttons.btn_primary('Refresh Config', click='fetchConfig()', disabled='actionPending', extra_class='btn-secondary') }}
    </div>
    <div class="notice success" x-show="actionMessage" x-text="actionMessage" style="margin-top: 16px;"></div>
    <div class="notice error" x-show="actionError" x-text="actionError" style="margin-top: 16px;"></div>
  {% endcall %}
</div>

<script>
function alsaSettingsApp() {
  return {
    devices: { playback: [], capture: [] },
    formatOptions: ['S16_LE', 'S24_3LE', 'S32_LE'],
    config: {
      alsa: {
        input_device: '',
        output_device: '',
        sample_rate: '',
        channels: '',
        format: 'S32_LE',
        period_frames: '',
        buffer_frames: ''
      },
      filter: {
        ratio: 2,
        phase_type: 'minimum',
        directory: ''
      }
    },
    ratioOptions: [
      { label: '1x (Bypass)', value: 1 },
      { label: '2x', value: 2 },
      { label: '4x', value: 4 },
      { label: '8x', value: 8 },
      { label: '16x', value: 16 }
    ],
    phaseOptions: [
      { label: 'Minimum', value: 'minimum' },
      { label: 'Linear', value: 'linear' }
    ],
    actionPending: false,
    actionMessage: null,
    actionError: null,
    init() {
      this.fetchDevices();
      this.fetchConfig();
    },
    async fetchDevices() {
      try {
        const response = await fetch('/api/alsa/devices');
        if (!response.ok) {
          throw new Error('Failed to load devices');
        }
        const data = await response.json();
        this.devices.playback = data.playback || [];
        this.devices.capture = data.capture || [];
      } catch (err) {
        this.actionError = err.message;
      }
    },
    async fetchConfig() {
      try {
        const response = await fetch('/api/config');
        if (!response.ok) {
          throw new Error('Failed to load config');
        }
        const data = await response.json();
        const settings = data.settings || {};
        const alsa = settings.alsa || {};
        const filter = settings.filter || {};
        this.config.alsa.input_device = alsa.input_device || '';
        this.config.alsa.output_device = alsa.output_device || '';
        this.config.alsa.sample_rate = alsa.sample_rate || '';
        this.config.alsa.channels = alsa.channels || '';
        this.config.alsa.format = alsa.format || this.config.alsa.format;
        this.config.alsa.period_frames = alsa.period_frames || '';
        this.config.alsa.buffer_frames = alsa.buffer_frames || '';
        this.config.filter.ratio = filter.ratio || this.config.filter.ratio;
        this.config.filter.phase_type = filter.phase_type || this.config.filter.phase_type;
        this.config.filter.directory = filter.directory || '';
      } catch (err) {
        this.actionError = err.message;
      }
    },
    async saveConfig() {
      this.actionPending = true;
      this.actionMessage = null;
      this.actionError = null;
      const payload = {
        alsa: {
          input_device: this.config.alsa.input_device || null,
          output_device: this.config.alsa.output_device || null,
          sample_rate: this.config.alsa.sample_rate ? Number(this.config.alsa.sample_rate) : null,
          channels: this.config.alsa.channels ? Number(this.config.alsa.channels) : null,
          format: this.config.alsa.format || null,
          period_frames: this.config.alsa.period_frames ? Number(this.config.alsa.period_frames) : null,
          buffer_frames: this.config.alsa.buffer_frames ? Number(this.config.alsa.buffer_frames) : null
        },
        filter: {
          ratio: this.config.filter.ratio ? Number(this.config.filter.ratio) : null,
          phase_type: this.config.filter.phase_type || null,
          directory: this.config.filter.directory || null
        }
      };
      try {
        const response = await fetch('/api/config', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.detail || 'Failed to save config');
        }
        const data = await response.json();
        if (data.restart_required) {
          this.actionMessage = 'Saved. Restart required to apply ALSA changes.';
        } else {
          this.actionMessage = 'Saved and applied.';
        }
      } catch (err) {
        this.actionError = err.message;
      } finally {
        this.actionPending = false;
      }
    }
  };
}
</script>
{% endblock %}

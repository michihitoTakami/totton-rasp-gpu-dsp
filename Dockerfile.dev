# X86 Development Environment Dockerfile
# For local testing with ALSA loopback and Vulkan GPU
# Target: Ubuntu 24.04 with RTX 2070 Super (SM 7.5)

FROM ubuntu:24.04 AS build

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        pkg-config \
        git \
        ca-certificates \
        python3 \
        python3-pip \
        libasound2-dev \
        libzmq3-dev \
        libvulkan-dev \
        glslang-dev \
        glslang-tools \
        jq \
        gdb \
        valgrind \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /opt/totton-dsp
COPY . .

# Build with debug symbols for development
# CUDA_ARCHITECTURES=75 for RTX 2070 Super (SM 7.5)
RUN cmake -B build \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DENABLE_VULKAN=ON \
    -DUSE_VKFFT=ON \
    -DENABLE_ALSA=ON \
    -DENABLE_ZMQ=ON \
    -DCMAKE_CUDA_ARCHITECTURES=75 \
    && cmake --build build -j"$(nproc)"

FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-setuptools \
        python3-wheel \
        libasound2t64 \
        libzmq5t64 \
        libvulkan1 \
        glslang-tools \
        ca-certificates \
        jq \
        vulkan-tools \
        mesa-vulkan-drivers \
        alsa-utils \
    && rm -rf /var/lib/apt/lists/*

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /opt/totton-dsp

# Copy built binaries from build stage
COPY --from=build /opt/totton-dsp/build/alsa_streamer /usr/local/bin/alsa_streamer
COPY --from=build /opt/totton-dsp/build/zmq_control_server /usr/local/bin/zmq_control_server

# Copy application files
COPY --from=build /opt/totton-dsp/web /opt/totton-dsp/web
COPY --from=build /opt/totton-dsp/data /opt/totton-dsp/data
COPY --from=build /opt/totton-dsp/scripts /opt/totton-dsp/scripts
COPY docker/entrypoint.sh /usr/local/bin/totton-entrypoint.sh

RUN pip3 install --no-cache-dir \
        fastapi \
        uvicorn \
        jinja2 \
        python-multipart \
        pyzmq \
    && chmod +x /usr/local/bin/totton-entrypoint.sh

EXPOSE 8080

ENTRYPOINT ["/usr/local/bin/totton-entrypoint.sh"]
